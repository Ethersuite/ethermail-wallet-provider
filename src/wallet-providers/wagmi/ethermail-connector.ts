import { createConnector } from '@wagmi/core'
import { EtherMailSignInOnSuccessEvent, EtherMailTokenErrorEvent } from '../../provider/utils';
import { EtherMailProvider } from '../../provider';
import { BrowserProvider } from 'ethers';
import { Chain } from 'viem';
import { jwtDecode } from 'jwt-decode';

type EnvironmentType = 'dev' | 'staging' | 'production';

export type EthermailConnectorParameters = {
    widget_id: string;
    afid: string;
    community_name: string;
    permissions: string;
    loginType: string;
    connectButtonLabel?: string
    environment?: EnvironmentType;
}

export function ethermailConnector(parameters: EthermailConnectorParameters) {
    let ethermailProvider: EtherMailProvider | null;
    let provider: BrowserProvider | null;

    return createConnector((config: any) => {
        validateParameters(parameters);
        let isConnected: boolean = false;

        return {
            id: 'ethermail',
            name: 'Ethermail',
            type: 'ethermail',
            icon: 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjU4OCIgaGVpZ2h0PSI1MTIiPgo8cGF0aCBkPSJNMCAwIEMyLjIwMDk5MTUzIC0wLjAyNTMwNTUyIDQuNDAyNTExMzMgLTAuMDE2OTc5MTggNi42MDMzODk3NCAwLjAxNjc1OTg3IEM3LjgxNTUzODk0IDAuMDExNjMzMzIgOS4wMjc2ODgxNCAwLjAwNjUwNjc3IDEwLjI3NjU2OTEzIDAuMDAxMjI0ODggQzEzLjY0MzE3Njg1IC0wLjAwNjk1OTgyIDE3LjAwNzY5ODY5IDAuMDExODIzMTMgMjAuMzc0MDU0NDMgMC4wNDE4OTMyNCBDMjQuMDAzMTkzMDIgMC4wNjc3NzY5IDI3LjYzMjI2NTg4IDAuMDU5MDM3NzQgMzEuMjYxNDcwNzkgMC4wNTQ0Nzk2IEMzNy41NDk3OTYzNSAwLjA1MTMzMTcyIDQzLjgzNzc0ODcgMC4wNzAxNzQ0OCA1MC4xMjU5ODAzOCAwLjEwMzkwNjYzIEM1OS4yMTc2NjgzOCAwLjE1MjY0NTc0IDY4LjMwOTE3NTcyIDAuMTY4MjkyODggNzcuNDAwOTgwMiAwLjE3NTgzNDU4IEM5Mi4xNTEzMTE5OSAwLjE4ODk3MDA1IDEwNi45MDE0NDQ4MSAwLjIyODkwOTYzIDEyMS42NTE2Njg1NSAwLjI4NTY1MDI1IEMxMzUuOTgxMDg1NSAwLjM0MDcxNDg2IDE1MC4zMTA0NDg0MyAwLjM4MzE5MDA1IDE2NC42Mzk5NDk4IDAuNDA4Njk3MTMgQzE2NS45NjQ1OTk0OSAwLjQxMTA2MTY0IDE2NS45NjQ1OTk0OSAwLjQxMTA2MTY0IDE2Ny4zMTYwMDk3OSAwLjQxMzQ3MzkyIEMxNzEuNzQ2MjEyIDAuNDIxMzA0MDggMTc2LjE3NjQxNDYgMC40Mjg4ODYzNCAxODAuNjA2NjE3NDUgMC40MzYzNDUzNCBDMjE3LjM2NjI0MTEyIDAuNDk4NTU3MTkgMjU0LjEyNTYzODU3IDAuNjA0MjQ2MTIgMjkwLjg4NTA2Njk5IDAuNzM4Mjg2OTcgQzI5MS4yODMzMTE3NyAxLjQ1MTQyNTU1IDI5MS42ODE1NTY1NSAyLjE2NDU2NDEzIDI5Mi4wOTE4NjkzNSAyLjg5OTMxMjk3IEMyOTMuNTkyMzMxODggNS41ODUyMzg3NSAyOTUuMDkzNTYyMjggOC4yNzA3MzM1MyAyOTYuNTk1Mjg3MzIgMTAuOTU1OTUzNiBDMjk3LjU1NTYxODk1IDEyLjY3MzY0MjM4IDI5OC41MTUwOTEzMiAxNC4zOTE4MTE0NyAyOTkuNDc0NTQ0NTMgMTYuMTA5OTkxMDcgQzMwMi44NjM1NzM0OCAyMi4xNjg1NTkzNiAzMDYuMjgwOTAwNTggMjguMjA1MDQ0OTcgMzA5LjgyMjU2Njk5IDM0LjE3NTc4Njk3IEMzMTAuMjM0NzM0NjUgMzQuODcwNzY3OSAzMTAuNjQ2OTAyMzEgMzUuNTY1NzQ4ODMgMzExLjA3MTU1OTkxIDM2LjI4MTc4OTc4IEMzMTEuNDQ3MDA5NDMgMzYuOTE0NTQzMjMgMzExLjgyMjQ1ODk1IDM3LjU0NzI5NjY4IDMxMi4yMDkyODU3NCAzOC4xOTkyMjQ0NyBDMzE1LjU2NjUyMTYzIDQzLjg3MTU3MzEgMzE4Ljg0NjY3MzI0IDQ5LjU4ODM1NTggMzIyLjEzNTA2Njk5IDU1LjMwMDc4Njk3IEMzMjcuMDI2NTIwMjIgNjMuNzk0ODQ5OTcgMzMxLjkzODk0IDcyLjI3NTk0MjY3IDMzNi44ODUwNjY5OSA4MC43MzgyODY5NyBDMzQ0LjkwNzk1OTU3IDk0LjQ2ODcxMDM1IDM1Mi44NDM2NTA2MyAxMDguMjQ5MDY4NDcgMzYwLjc4MDU3NDggMTIyLjAyOTMwMjYgQzM2Ny40NTQ2MzAxIDEzMy42MTUxMDQ2MyAzNzQuMTM5NzA3ODMgMTQ1LjE5MzgyMDUgMzgwLjg4NTA2Njk5IDE1Ni43MzgyODY5NyBDMzg4LjkwNzc0MjEgMTcwLjQ2ODgzODg1IDM5Ni44NDM2NDk1NyAxODQuMjQ5MDY2NjMgNDA0Ljc4MDU3NDggMTk4LjAyOTMwMjYgQzQxMS42NDU0NjA0MyAyMDkuOTQ2Mzc1ODQgNDE4LjUyMTY0NzYgMjIxLjg1NjU1MzMyIDQyNS40NDc1NjY5OSAyMzMuNzM4Mjg2OTcgQzQyNi4wMDcxMDA2OCAyMzQuNjk4Nzk5NjcgNDI2LjU2NjYzNDM3IDIzNS42NTkzMTIzNiA0MjcuMTQzMTIzNjMgMjM2LjY0ODkzMTUgQzQyNy45NDU0NDQxOCAyMzguMDIzNDc0OTYgNDI3Ljk0NTQ0NDE4IDIzOC4wMjM0NzQ5NiA0MjguNzYzOTczMjQgMjM5LjQyNTc4Njk3IEM0MjkuMjc0NjAzMTIgMjQwLjMxMDA4Mzg1IDQyOS43ODUyMzMgMjQxLjE5NDM4MDcyIDQzMC4zMTEzMzY1MiAyNDIuMTA1NDc0NDcgQzQzMS4zOTAyNjAxMyAyNDMuOTEwNDg3MjMgNDMyLjUxOTUwNzEgMjQ1LjY4NjA4Mzg1IDQzMy42ODkyNjYyIDI0Ny40MzM1OTk0NyBDNDM0LjI1NzkwMzkgMjQ4LjI5NzI3MTM1IDQzNC44MjY1NDE2IDI0OS4xNjA5NDMyMiA0MzUuNDEyNDEwNzQgMjUwLjA1MDc4Njk3IEM0MzUuOTM0NDAwNDggMjUwLjgxMDA0NDc4IDQzNi40NTYzOTAyMyAyNTEuNTY5MzAyNiA0MzYuOTk0MTk3ODUgMjUyLjM1MTU2ODIyIEM0MzguMjcwOTY0MzcgMjU1Ljc3MjE0MDg2IDQzNy4zMzE0NTk0MSAyNTcuNDUxOTkwNTQgNDM1Ljg4NTA2Njk5IDI2MC43MzgyODY5NyBDNDM0Ljk1MjI4MTAxIDI2Mi41NTE1MDk1NCA0MzMuOTY2MTI3MzcgMjY0LjMzODAwNTU4IDQzMi45MzU4NDgyNCAyNjYuMDk3NjYxOTcgQzQzMi4zNDI4Nzk0OSAyNjcuMTE3MzEwNDEgNDMxLjc0OTkxMDc0IDI2OC4xMzY5NTg4NSA0MzEuMTM4OTczMjQgMjY5LjE4NzUwNTcyIEM0MzAuNDk4MzA5MTcgMjcwLjI3Njc2MzUzIDQyOS44NTc2NDUxMSAyNzEuMzY2MDIxMzUgNDI5LjE5NzU2Njk5IDI3Mi40ODgyODY5NyBDNDI4LjUyMjUwMDU5IDI3My42NDU0OTY2OSA0MjcuODQ4MDMyMzcgMjc0LjgwMzA1NTU0IDQyNy4xNzQxMjk0OSAyNzUuOTYwOTQzMjIgQzQyNS43NzQ5MDg5NCAyNzguMzYzOTkyOCA0MjQuMzczMTM3NjMgMjgwLjc2NTUyNjE3IDQyMi45Njk1Mzk2NCAyODMuMTY2MDIxMzUgQzQxOS43NTA1NzMzNCAyODguNjc2MTU1MDkgNDE2LjU2OTg2ODU0IDI5NC4yMDgzNjMxNCA0MTMuMzg1MDY2OTkgMjk5LjczODI4Njk3IEM0MTIuMTM1MjQ1NzQgMzAxLjkwNTA1Njc2IDQxMC44ODUyNDUxOCAzMDQuMDcxNzIzMTIgNDA5LjYzNTA2Njk5IDMwNi4yMzgyODY5NyBDNDA5LjAxNjMxNjk5IDMwNy4zMTA3ODY5NyA0MDguMzk3NTY2OTkgMzA4LjM4MzI4Njk3IDQwNy43NjAwNjY5OSAzMDkuNDg4Mjg2OTcgQzM4NS44ODUwNjY5OSAzNDcuNDA0OTUzNjQgMzY0LjAxMDA2Njk5IDM4NS4zMjE2MjAzMSAzNDIuMTM1MDY2OTkgNDIzLjIzODI4Njk3IEMzNDEuNTE2MjM2NDIgNDI0LjMxMDk0ODEgMzQwLjg5NzQwNTg1IDQyNS4zODM2MDkyNCAzNDAuMjU5ODIyODUgNDI2LjQ4ODc3NTI1IEMzMzkuMDEwNzExODEgNDI4LjY1Mzg1NzY4IDMzNy43NjE1MjU2OSA0MzAuODE4ODk2NzkgMzM2LjUxMjI2NDI1IDQzMi45ODM4OTI0NCBDMzMzLjM3MzA0Mzg5IDQzOC40MjQ0NDQwMyAzMzAuMjM1MTYxMzYgNDQzLjg2NTc1OTEzIDMyNy4wOTk5MTA3NCA0NDkuMzA4NTk5NDcgQzMxOS4yNzA0ODY0OCA0NjIuODk3MTgyMSAzMTEuNDA2NTIzODMgNDc2LjQ2NDkwNjk1IDMwMy40ODY2Mjk0OSA0OTAuMDAwOTgyMjggQzMwMi40MzEzMjI0NyA0OTEuODA0NjU2NDEgMzAxLjM3NjYyMDExIDQ5My42MDg2ODQ0OCAzMDAuMzIyNTY2OTkgNDk1LjQxMzA5MTY2IEMyOTguOTA3NTc1MjYgNDk3LjgzNDk3NTI4IDI5Ny40OTA0OTYyOSA1MDAuMjU1NjIyMzQgMjk2LjA3MjU2Njk5IDUwMi42NzU3ODY5NyBDMjk1LjY1NzczMDU2IDUwMy4zODYxNDA5OCAyOTUuMjQyODk0MTMgNTA0LjA5NjQ5NDk4IDI5NC44MTU0ODY5MSA1MDQuODI4Mzc0ODYgQzI5Mi4wMDAzMjk5OCA1MDkuNjIzMDIzOTggMjkyLjAwMDMyOTk4IDUwOS42MjMwMjM5OCAyOTAuODg1MDY2OTkgNTEwLjczODI4Njk3IEMyODkuMzE4NjU1NCA1MTAuODQ2OTIwMzUgMjg3Ljc0NzM3MTQ0IDUxMC44ODU5MDQzOSAyODYuMTc3MjQxMzMgNTEwLjg5NzY0Nzg2IEMyODQuNjQwMjUyNiA1MTAuOTEyNjYwMDYgMjg0LjY0MDI1MjYgNTEwLjkxMjY2MDA2IDI4My4wNzIyMTM1OSA1MTAuOTI3OTc1NTQgQzI4MS4zNjMwMjM2NyA1MTAuOTM2OTA3NjEgMjgxLjM2MzAyMzY3IDUxMC45MzY5MDc2MSAyNzkuNjE5MzA0NjYgNTEwLjk0NjAyMDEzIEMyNzguNDE5NDQ2ODEgNTEwLjk1NjA0NjkxIDI3Ny4yMTk1ODg5NyA1MTAuOTY2MDczNjkgMjc1Ljk4MzM3MTc5IDUxMC45NzY0MDQzMSBDMjcyLjYzNzYxNjU2IDUxMS4wMDMwNTk2NyAyNjkuMjkxODkwNDggNTExLjAyNTA2NzczIDI2NS45NDYwOTE3NyA1MTEuMDQ0OTIwMjEgQzI2My4wNzk5NjIyNCA1MTEuMDYyNjg5NCAyNjAuMjEzODY0MzcgNTExLjA4NDExNDY0IDI1Ny4zNDc3NTk2IDUxMS4xMDU0NTk5MSBDMjMwLjE3NDg4Mjg2IDUxMS4zMDY3NjUxOSAyMDMuMDAxMjI0IDUxMS40MTAzMTQ4OSAxNzUuODI3NzYxNjUgNTExLjQ5Mzk3NjU5IEMxNzIuMjg5MDAxNDQgNTExLjUwNTA2NTE1IDE2OC43NTAyNDE5NiA1MTEuNTE2MzU3MzggMTY1LjIxMTQ4MyA1MTEuNTI3ODM3NzUgQzE2My44OTIxMzE5NCA1MTEuNTMyMTA0NTUgMTYzLjg5MjEzMTk0IDUxMS41MzIxMDQ1NSAxNjIuNTQ2MTI3MzMgNTExLjUzNjQ1NzU1IEMxNDguMzAyMjIyMSA1MTEuNTgzOTIyNjkgMTM0LjA1OTA1OTM5IDUxMS42ODAyMTc1NiAxMTkuODE1NTU4NDkgNTExLjc5NTQwODgzIEMxMDUuMTk3NjcxOSA1MTEuOTEyNjQ4MDQgOTAuNTgwMTcxMjUgNTExLjk4MDY0NTI3IDc1Ljk2MTgyNjM4IDUxMi4wMDIxMDc3NCBDNjcuNzUxNjQ2MjcgNTEyLjAxNTUxMzI1IDU5LjU0Mjg0ODA4IDUxMi4wNTEyODk1NiA1MS4zMzMxMzk0MiA1MTIuMTQzMzQyOTcgQzQ0LjMzOTU0ODQyIDUxMi4yMjE3NDcxNyAzNy4zNDc1MDA1MyA1MTIuMjU2MjYxMDEgMzAuMzUzNDc2NCA1MTIuMjMzMzE4MDggQzI2Ljc4NDY4MjA2IDUxMi4yMjMwMDYwNiAyMy4yMTkyMzg1IDUxMi4yMzM3MTcwOCAxOS42NTA5OTkwNyA1MTIuMzAxNDE2NCBDLTEuMTg1Mjg5NTUgNTEyLjY3Njc1MzI4IC0xLjE4NTI4OTU1IDUxMi42NzY3NTMyOCAtNi4wMDQwNTM4MyA1MDkuNDg4MzA2NTIgQy05LjMwMTMxNjI0IDUwNi4wNzQ2NjgyNCAtMTAuNjQxNzI1NTYgNTAyLjIxODgxNjExIC0xMi4xMTQ5MzMwMSA0OTcuNzM4Mjg2OTcgQy0xMy4yNTAyODc1OSA0OTUuNjk5NDAwMjcgLTE0LjQyMzM3NzgxIDQ5My42ODA1ODA5MyAtMTUuNjUwMDg5MjYgNDkxLjY5NTMxODIyIEMtMTYuODI3Nzg2NTEgNDg5LjY0ODI0MjIzIC0xOC4wMDM1MDgzOSA0ODcuNjAwMDI4NzYgLTE5LjE3NzQzMzAxIDQ4NS41NTA3ODY5NyBDLTIwLjE1NjQ0NDE1IDQ4My44NDc4NTkxNiAtMjEuMTM1NDU4NDkgNDgyLjE0NDkzMzE3IC0yMi4xMTQ2NTgzNiA0ODAuNDQyMTEzODggQy0yMy4xMTk0MDYgNDc4LjY5NDMzMjM3IC0yNC4xMjMzMzIxNiA0NzYuOTQ2MDgxMDEgLTI1LjEyNzE0MDA1IDQ3NS4xOTc3NTk2MyBDLTI4LjI4MjE1OTMxIDQ2OS43MDY4OTQ2IC0zMS40NDg5MTI2NSA0NjQuMjIyODEzNTIgLTM0LjYxNDkzMzAxIDQ1OC43MzgyODY5NyBDLTM1Ljg2NDk5NDEzIDQ1Ni41NzE2NTU1NyAtMzcuMTE0OTk0MDEgNDU0LjQwNDk4ODgzIC0zOC4zNjQ5MzMwMSA0NTIuMjM4Mjg2OTcgQy0zOC45ODM2ODMwMSA0NTEuMTY1Nzg2OTcgLTM5LjYwMjQzMzAxIDQ1MC4wOTMyODY5NyAtNDAuMjM5OTMzMDEgNDQ4Ljk4ODI4Njk3IEMtNDUuODY0OTMzMDEgNDM5LjIzODI4Njk4IC00NS44NjQ5MzMwMSA0MzkuMjM4Mjg2OTggLTQ3Ljc0MDE3NzE1IDQzNS45ODc3OTg2OSBDLTQ4Ljk4OTI4ODE5IDQzMy44MjI3MTYyNyAtNTAuMjM4NDc0MzEgNDMxLjY1NzY3NzE1IC01MS40ODc3MzU3NSA0MjkuNDkyNjgxNSBDLTU0LjYyNjk1NjExIDQyNC4wNTIxMjk5MSAtNTcuNzY0ODM4NjQgNDE4LjYxMDgxNDgxIC02MC45MDAwODkyNiA0MTMuMTY3OTc0NDcgQy02Ni45NDU0ODQ2IDQwMi42NzU5NjYwNCAtNzMuMDA2MDM1MiAzOTIuMTkzNDcwMjEgLTc5LjExNDkzMzAxIDM4MS43MzgyODY5NyBDLTg1Ljg2MTk0NDk1IDM3MC4xOTA5OTE4MSAtOTIuNTQ4MzI2MTkgMzU4LjYwOTI2NjcgLTk5LjIyMzgxOTczIDM0Ny4wMjA1MTM1MyBDLTEwMi4zNTE3MzQ1IDM0MS41OTE2ODc1NSAtMTA1LjQ4MzUxNzQ5IDMzNi4xNjUwOTQxNiAtMTA4LjYxNDkzMzAxIDMzMC43MzgyODY5NyBDLTEwOS44NjQ5NTE4IDMyOC41NzE2MzExNSAtMTExLjExNDk1MTggMzI2LjQwNDk2NDQ4IC0xMTIuMzY0OTMzMDEgMzI0LjIzODI4Njk3IEMtMTEyLjk4MzY4MzAxIDMyMy4xNjU3ODY5NyAtMTEzLjYwMjQzMzAxIDMyMi4wOTMyODY5NyAtMTE0LjIzOTkzMzAxIDMyMC45ODgyODY5NyBDLTExOS44NjQ5MzMwMSAzMTEuMjM4Mjg2OTcgLTExOS44NjQ5MzMwMSAzMTEuMjM4Mjg2OTcgLTEyMS43NDI4NjI3IDMwNy45ODMxNjAwMiBDLTEyMi45ODMwNDA2MyAzMDUuODMzNTUwNjMgLTEyNC4yMjMyNzQyOCAzMDMuNjgzOTczMzkgLTEyNS40NjM1NjU4MyAzMDEuNTM0NDI5NTUgQy0xMjguMzg4NDM1MzEgMjk2LjQ2NTE5NDg1IC0xMzEuMzEyNzQxMzQgMjkxLjM5NTYzNzYxIC0xMzQuMjM1MDUwMiAyODYuMzI0OTI2MzggQy0xMzUuNjEzMDAyMzkgMjgzLjkzNDAyMSAtMTM2Ljk5MTI3NDc0IDI4MS41NDMzMDAyNiAtMTM4LjM2OTU3MTY5IDI3OS4xNTI1OTM2MSBDLTEzOS4zNDAzNDI4NCAyNzcuNDY4NDQ3MzQgLTE0MC4zMTA2NTE3NiAyNzUuNzg0MDM0NjYgLTE0MS4yODA5NDg2NCAyNzQuMDk5NjE1MSBDLTE0MS44NzA2OTQ3MyAyNzMuMDc2NzQ0IC0xNDIuNDYwNDQwODMgMjcyLjA1Mzg3MjkxIC0xNDMuMDY4MDU4MDEgMjcxLjAwMDAwNTcyIEMtMTQzLjg0MzkxMjUxIDI2OS42NTM2MjAyMiAtMTQzLjg0MzkxMjUxIDI2OS42NTM2MjAyMiAtMTQ0LjYzNTQ0MDgzIDI2OC4yODAwMzUwMiBDLTE0NS42NDEwNjM0IDI2Ni41NTIzODg3MiAtMTQ2LjY4NzgyNzIyIDI2NC44NDgxNzk0MyAtMTQ3Ljc2OTcxODE3IDI2My4xNjcyNDIwNSBDLTE0OS45Mjg0NzM1NiAyNTkuMjY5MzM2OTEgLTE0OS45NDczMTM5NSAyNTYuMDc0MDk2NzcgLTE0OS4xMTQ5MzMwMSAyNTEuNzM4Mjg2OTcgQy0xNDcuNDQ1NDc4NTMgMjQ3LjgzMjUwNTQ2IC0xNDUuMjUzMDEyMjYgMjQ0LjMyNTQ1Nzc2IC0xNDIuOTg5OTMzMDEgMjQwLjczODI4Njk3IEMtMTQxLjY5MzM3NDk2IDIzOC42MDQyNTgyNiAtMTQwLjM5OTE3Mzk3IDIzNi40Njg3OTYwMSAtMTM5LjEwNzEyMDUxIDIzNC4zMzIwMzY5NyBDLTEzOC4xMDg5MDI3NCAyMzIuNjk2MjE2NjYgLTEzOC4xMDg5MDI3NCAyMzIuNjk2MjE2NjYgLTEzNy4wOTA1MTg5NSAyMzEuMDI3MzQ5NDcgQy0xMzMuOTcxNTA1MjYgMjI1LjgzNDY0NjUgLTEzMS4wNDU2ODYxNSAyMjAuNTM4NzggLTEyOC4xMTQ5MzMwMSAyMTUuMjM4Mjg2OTcgQy0xMjIuOTgxNDI3NzEgMjA2LjAwNzQ0OTM3IC0xMTcuNzEyNzY4MTkgMTk2Ljg2NTg1IC0xMTIuMzY0OTMzMDEgMTg3Ljc1NzgxODIyIEMtMTA4LjE5MjQ5MzQyIDE4MC42MzMwMDUwNyAtMTA0LjEyOTk4MDU4IDE3My40NTI4MjU1NiAtMTAwLjExNDkzMzAxIDE2Ni4yMzgyODY5NyBDLTk0Ljk3ODYxOTEyIDE1Ny4wMDg5NzI5NSAtODkuNzEyODA3NjcgMTQ3Ljg2NTkxNzI0IC04NC4zNjQ5MzMwMSAxMzguNzU3ODE4MjIgQy04MC4xOTI0OTM0MiAxMzEuNjMzMDA1MDcgLTc2LjEyOTk4MDU4IDEyNC40NTI4MjU1NiAtNzIuMTE0OTMzMDEgMTE3LjIzODI4Njk3IEMtNjYuOTc4NjE5MTIgMTA4LjAwODk3Mjk1IC02MS43MTI4MDc2NyA5OC44NjU5MTcyNCAtNTYuMzY0OTMzMDEgODkuNzU3ODE4MjIgQy01Mi4xOTI0OTM0MiA4Mi42MzMwMDUwNyAtNDguMTI5OTgwNTggNzUuNDUyODI1NTYgLTQ0LjExNDkzMzAxIDY4LjIzODI4Njk3IEMtMzguOTg1OTY4MDIgNTkuMDIyMTc3OTkgLTMzLjczMDAxOTYyIDQ5Ljg5MDc3ODI1IC0yOC4zODY5MDU2NyA0MC43OTczNjkgQy0yMy4zNzYxNjc4OSAzMi4yNDU2NTMzOCAtMTguNTI3NDIyIDIzLjYwNzc2NzA1IC0xMy43MzIxMjA1MSAxNC45MzM1OTk0NyBDLTEzLjE4NTU1ODAxIDEzLjk0ODc1NTcyIC0xMi42Mzg5OTU1MSAxMi45NjM5MTE5NyAtMTIuMDc1ODcwNTEgMTEuOTQ5MjI0NDcgQy0xMS41OTk0MDA3OSAxMS4wODYwMzYgLTExLjEyMjkzMTA2IDEwLjIyMjg0NzUyIC0xMC42MzIwMjI4NiA5LjMzMzUwMTgyIEMtMTAuMTMxMzgzMjEgOC40NzcwODA5MiAtOS42MzA3NDM1NiA3LjYyMDY2MDAyIC05LjExNDkzMzAxIDYuNzM4Mjg2OTcgQy04LjY2NTMzMzQ0IDUuNzA5NjQyMTYgLTguMjE1NzMzODcgNC42ODA5OTczNSAtNy43NTI1MTAwNyAzLjYyMTE4MTQ5IEMtNC43NTI0ODU5NiAwLjM0MjEyOTIxIC00LjIyMjcwNjY4IDAuMjgyODU4MTEgMCAwIFogTTI5LjIzNTg5NzA2IDg4LjQxNzQ4NjE5IEMyNy45MDAyMTA2NSA5MS41NTYxNjgzNiAyNi43NzcwNDI2IDk0LjY1NTIwMTY3IDI1Ljc4ODUwNDYgOTcuOTE4OTc2NzggQzI0LjU2MjA1NzcgMTAxLjc0NjI4NTA1IDIyLjc1MzYzNTIyIDEwNC44MzA1NjMzIDIwLjY1ODUwNDQ5IDEwOC4yNTAwMDU3MiBDMTkuNTIzMzM4ODQgMTEwLjMwNzMwMjgyIDE4LjM5MDQ1ODc0IDExMi4zNjU4NjI5NyAxNy4yNjAwNjY5OSAxMTQuNDI1Nzg2OTcgQzExLjQzNTg4MDExIDEyNC45NjkwNjYzMyA1LjUxNzE0MjM4IDEzNS40NTE4NDc3NSAtMC40ODI2MDg4IDE0NS44OTYwMDE4MiBDLTMuNjU3MTQxMjQgMTUxLjQyMzY1NzYzIC02LjgyNDc5OTU3IDE1Ni45NTUyNDU1MyAtOS45ODk5MzMwMSAxNjIuNDg4Mjg2OTcgQy0xMC4zMjg4MjU1MyAxNjMuMDgwNjExMTkgLTEwLjY2NzcxODA1IDE2My42NzI5MzU0MSAtMTEuMDE2ODgwMDQgMTY0LjI4MzIwODg1IEMtMTYuNDM0MTY3MzEgMTczLjc1NTYxMDMyIC0yMS43ODUwNzkyIDE4My4yNjM3MDM1NSAtMjcuMTA0NDM0OTcgMTkyLjc5MTUwOTYzIEMtMzEuMjM3MTc1MzUgMjAwLjE4ODMwNjQyIC0zNS40MjE4NDQ4NSAyMDcuNTUzNzA5NDMgLTM5LjYzMzk3NTk4IDIxNC45MDU1MjMzIEMtNDMuNDM4MjQ5NzUgMjIxLjU0NzQzMTk1IC00Ny4yMjA4MTUxOCAyMjguMjAxMzY0NDUgLTUwLjk4OTkzMzAxIDIzNC44NjMyODY5NyBDLTUxLjUxMzM3Mjk2IDIzNS43ODcwNjEzOSAtNTIuMDM2ODEyOSAyMzYuNzEwODM1OCAtNTIuNTc2MTE0NjUgMjM3LjY2MjYwMzM4IEMtNTMuNTg4MDYwMjEgMjM5LjQ1MjgzMjA1IC01NC41ODcxMjI5OSAyNDEuMjUwNDEwOTEgLTU1LjU3MjQ1MjU1IDI0My4wNTU0MjU2NCBDLTU3LjExNDkzMzAxIDI0NS43MzgyODY5NyAtNTcuMTE0OTMzMDEgMjQ1LjczODI4Njk3IC01OS4wMjg1MDcyMyAyNDguNDc3Nzg4OTMgQy02MC44NTYzMzUzMSAyNTEuMjQ1MDE5NjYgLTYyLjIwNzAxMzI3IDI1My41NDU1MDIyIC02My4xMTQ5MzMwMSAyNTYuNzM4Mjg2OTcgQy02Mi4xODI3OTEyMyAyNjAuOTk0MTU3NzUgLTU5Ljk1MzEzMTE3IDI2NC4xMzA4MzgwNyAtNTcuNDg5OTMzMDEgMjY3LjY3NTc4Njk3IEMtNTYuMTM5NTM4MTcgMjY5Ljc4OTkyNTYyIC01NC43OTE5OTM0NyAyNzEuOTA1ODg2ODcgLTUzLjQ0Njk2NDI2IDI3NC4wMjM0NDMyMiBDLTUyLjczMTA1MTE4IDI3NS4xMjA1OTY1NCAtNTIuMDE1MTM4MDkgMjc2LjIxNzc0OTg2IC01MS4yNzc1MzA2NyAyNzcuMzQ4MTUwMjUgQy00OC4wMjM3NjA2IDI4Mi4zODcyOTcxNiAtNDUuMTA4MTYxNjEgMjg3LjYyMzc4NDE0IC00Mi4xNzAxMzkzMSAyOTIuODUwNjgzMjEgQy00MC41MDA0NTU3MiAyOTUuODE1Mjk2OCAtMzguODEwNzczMTEgMjk4Ljc2ODQ2Nzc5IC0zNy4xMjI3NDU1MSAzMDEuNzIyNjYxOTcgQy0zNi43ODg4MjI5NCAzMDIuMzA3ODcxMTcgLTM2LjQ1NDkwMDM2IDMwMi44OTMwODAzNyAtMzYuMTEwODU4OTIgMzAzLjQ5NjAyMzE4IEMtMzAuNzY3NDY5MzIgMzEyLjg1Nzk5MDM1IC0yNS4zNjY5NjIxNiAzMjIuMTg3MTU2MjkgLTE5Ljk3MzgxOTczIDMzMS41MjA1MTM1MyBDLTE2Ljg1MTY4Njk2IDMzNi45MjQ5OTM0MyAtMTMuNzMzNTIwOTcgMzQyLjMzMTc2MTA5IC0xMC42MTQ5MzMwMSAzNDcuNzM4Mjg2OTcgQy05LjM2NDk1MTggMzQ5LjkwNDk2NDQ4IC04LjExNDk1MTggMzUyLjA3MTYzMTE1IC02Ljg2NDkzMzAxIDM1NC4yMzgyODY5NyBDLTQuMzY0OTMzMDEgMzU4LjU3MTYyMDMxIC0xLjg2NDkzMzAxIDM2Mi45MDQ5NTM2NCAwLjYzNTA2Njk5IDM2Ny4yMzgyODY5NyBDMS4yNTM5NzgxMiAzNjguMzExMDI4NjcgMS44NzI4ODkyNSAzNjkuMzgzNzcwMzcgMi41MTA1NTUyNyAzNzAuNDg5MDE5MzkgQzMuNzU5MDU5MjEgMzcyLjY1MzE2ODc3IDUuMDA3NDMxODUgMzc0LjgxNzM5MzkgNi4yNTU2NzI0NSAzNzYuOTgxNjk1MTggQzkuNDAyNDgzNTYgMzgyLjQzNzUwODcgMTIuNTUxNjQ4NjkgMzg3Ljg5MTkzODgxIDE1LjcwNTM3OTQ5IDM5My4zNDM3NTU3MiBDMTYuMzQyODIwODkgMzk0LjQ0NjU0ODY5IDE2Ljk4MDI2MjMgMzk1LjU0OTM0MTY2IDE3LjYzNzAyMDExIDM5Ni42ODU1NTI2IEMxOC44MTQ1MTIwNCAzOTguNzIyNTI3NjggMTkuOTkyNzgyNzEgNDAwLjc1OTA1MzAxIDIxLjE3MjE3NjM2IDQwMi43OTQ5Mjc2IEMyNy40OTE0MDIwNyA0MTMuNzMxMjA2MDkgMzMuNjY4OTgzMDIgNDI0Ljc0MDU5OTk2IDM5Ljg4NTA2Njk5IDQzNS43MzgyODY5NyBDMTA4LjE5NTA2Njk5IDQzNS43MzgyODY5NyAxNzYuNTA1MDY2OTkgNDM1LjczODI4Njk3IDI0Ni44ODUwNjY5OSA0MzUuNzM4Mjg2OTcgQzI1Mi4xNjUwNjY5OSA0MjYuNDk4Mjg2OTcgMjU3LjQ0NTA2Njk5IDQxNy4yNTgyODY5NyAyNjIuODg1MDY2OTkgNDA3LjczODI4Njk3IEMyNzAuNzU2OTIxMjUgMzk0LjA1OTMyNzExIDI3OC42NTY0NTc0NyAzODAuMzk4NjA2MTIgMjg2LjYxODIyMTI4IDM2Ni43NzE5NzgzOCBDMjkyLjc4NDUxODI5IDM1Ni4yMTE4MTYxMyAyOTguODkwMTE3MzggMzQ1LjYxNjg2MTUyIDMwNC45OTM5NTM3IDMzNS4wMjA1MTM1MyBDMzA4Ljc0NDUzMDk4IDMyOC41MTA5OTEwOSAzMTIuNTAwMDg2ODggMzIyLjAwNDMzOTE3IDMxNi4yNTU0MjgzMSAzMTUuNDk3NTY0MzIgQzMxOS40MDg5MTg2IDMxMC4wMzI5NDAzNSAzMjIuNTU5NzM3MzkgMzA0LjU2NjgwNzk1IDMyNS43MDUzNzk0OSAyOTkuMDk3NjYxOTcgQzMyNi4zMzU4MTE2MSAyOTguMDAyOTI1NjQgMzI2Ljk2NjI0Mzc0IDI5Ni45MDgxODkzMiAzMjcuNjE1Nzc5ODggMjk1Ljc4MDI3OTE2IEMzMjguODY3MzU3NjEgMjkzLjYwNTIyMTI2IDMzMC4xMTY1ODg4NiAyOTEuNDI4ODExMjcgMzMxLjM2MzMzODQ3IDI4OS4yNTA5ODIyOCBDMzM0LjQyNDA1NzM4IDI4My45MjIyNjYxOSAzMzcuNTQwMjc2NCAyNzguNjQzMzIxMTMgMzQwLjc4NzQxMDc0IDI3My40MjU3ODY5NyBDMzQxLjQwMzQyMTQ4IDI3Mi40MjQ1MDc2OCAzNDIuMDE5NDMyMjIgMjcxLjQyMzIyODM4IDM0Mi42NTQxMDk5NSAyNzAuMzkxNjA3MjggQzM0My44MTk0MjA3NiAyNjguNTA1MTU1MzMgMzQ1LjAwMTIyMyAyNjYuNjI4NzU2NDMgMzQ2LjIwMTk2MTUyIDI2NC43NjQ2NTQxNiBDMzQ2LjcxNzQyNTM4IDI2My45MjU3OTY3NCAzNDcuMjMyODg5MjUgMjYzLjA4NjkzOTMyIDM0Ny43NjM5NzMyNCAyNjIuMjIyNjYxOTcgQzM0OC4yMjM2MDQ1OCAyNjEuNDk3ODg2NTggMzQ4LjY4MzIzNTkzIDI2MC43NzMxMTExOSAzNDkuMTU2Nzk1NSAyNjAuMDI2MzcyOTEgQzM1MC40NjQ0NTg2NyAyNTUuOTE3OTUyMTEgMzQ4LjQwMDk5MTMzIDI1Mi43NDExODEyIDM0Ni41MTkxMDAxOSAyNDkuMDgzMDEzNTMgQzM0NS45OTY2MjcwNCAyNDguMTkwNjYwMDIgMzQ1LjQ3NDE1MzkgMjQ3LjI5ODMwNjUgMzQ0LjkzNTg0ODI0IDI0Ni4zNzg5MTE5NyBDMzQ0LjM0Mjc5ODkyIDI0NS4zNTkxMDI0IDM0My43NDk3NDk2IDI0NC4zMzkyOTI4MyAzNDMuMTM4NzI5MSAyNDMuMjg4NTc5OTQgQzM0Mi40OTgxNDU2IDI0Mi4xOTk0ODMyNiAzNDEuODU3NTYyMSAyNDEuMTEwMzg2NTggMzQxLjE5NzU2Njk5IDIzOS45ODgyODY5NyBDMzQwLjUyMzIzOTg0IDIzOC44MzI1MzgxOCAzMzkuODQ5NTAzOCAyMzcuNjc2NDQ0MzEgMzM5LjE3NjMyNjc1IDIzNi41MjAwMjUyNSBDMzM3Ljc3Nzc2OTAyIDIzNC4xMTg0ODE0OSAzMzYuMzc2Njg0MDUgMjMxLjcxODQzODk0IDMzNC45NzM5MzQxNyAyMjkuMzE5MzQxNjYgQzMzMS43MzAzMDc4NyAyMjMuNzY1OTY4MjggMzI4LjUyOTkwMDIxIDIxOC4xODc2NjY2NyAzMjUuMzIyNTY2OTkgMjEyLjYxMzI4Njk3IEMzMTkuOTYzNTQzMjggMjAzLjMxNjYwOTQxIDMxNC41Njg3MjA3NyAxOTQuMDQxMzkzMjQgMzA5LjE1NDM1NDEgMTg0Ljc3Njg2MTE5IEMzMDQuMjM0NTU0MTcgMTc2LjM1MjU5MzU4IDI5OS4zNTk4NDU2MSAxNjcuOTAyNzQ4MDEgMjk0LjQ5MDUzNTc0IDE1OS40NDkyMjQ0NyBDMjg5Ljc0MTUxNDggMTUxLjIwOTcyMjMxIDI4NC45NTYxNjU3NSAxNDIuOTkxOTk1OTggMjgwLjE1Njc5NTUgMTM0Ljc4MTc0NCBDMjc1Ljg1MDIxMzYzIDEyNy40MDg1NDY0NyAyNzEuNTgxNjczMjUgMTIwLjAxMzk4OTU4IDI2Ny4zMjI1NjY5OSAxMTIuNjEzMjg2OTcgQzI2Mi40MjU0NzEyNCAxMDQuMTEwMTI0NzcgMjU3LjQ5NTMzNzQgOTUuNjI3NTkwMDkgMjUyLjUxMDA2Njk5IDg3LjE3NTc4Njk3IEMyNTEuOTU2MzM0MDggODYuMjM1MjU0NzUgMjUxLjQwMjYwMTE3IDg1LjI5NDcyMjUyIDI1MC44MzIwODg0NyA4NC4zMjU2ODkzMiBDMjUwLjMyNjIxMjAxIDgzLjQ3MDU1NzQ4IDI0OS44MjAzMzU1NCA4Mi42MTU0MjU2NCAyNDkuMjk5MTI5NDkgODEuNzM0MzgwNzIgQzI0OC44NTUyMDg1OSA4MC45ODM0MjEyNSAyNDguNDExMjg3NjkgODAuMjMyNDYxNzggMjQ3Ljk1MzkxNDY0IDc5LjQ1ODc0NTk2IEMyNDYuOTk5Mzg0OTQgNzcuNzc2Nzc2NCAyNDYuOTk5Mzg0OTQgNzcuNzc2Nzc2NCAyNDUuODg1MDY2OTkgNzYuNzM4Mjg2OTcgQzI0My4yNDk2Njk0MyA3Ni41ODcyNDgyOCAyNDAuNjM4NTE2NjggNzYuNTAxMzA1MzYgMjM4LjAwMDQ5OTczIDc2LjQ1NjUzMzQzIEMyMzcuMTY0MjI3ODggNzYuNDM4NzQ1NDMgMjM2LjMyNzk1NjA0IDc2LjQyMDk1NzQyIDIzNS40NjYzNDI2MyA3Ni40MDI2MzAzOSBDMjMyLjY0MTU1OTAzIDc2LjM0NDQxOTA1IDIyOS44MTY2OTU5IDc2LjI5Mzk0MjM4IDIyNi45OTE3NTY0NCA3Ni4yNDM5MDIyMSBDMjI0Ljk3NDkzOTE0IDc2LjIwNDkyMzM2IDIyMi45NTgxMjQgNzYuMTY1ODMyODMgMjIwLjk0MTMxMDg4IDc2LjEyNjYzODQxIEMyMDIuNDgyMzEwNiA3NS43ODAwMjYzNCAxODQuMDIxMzk1MzMgNzUuNTc2MjE4MjggMTY1LjU1OTk2MDM3IDc1LjQxMjY2MzQ2IEMxNTMuMTQ2NjQ3ODEgNzUuMzAwMDUwMjYgMTQwLjczNzIxMTkxIDc1LjE0MjQxNjIxIDEyOC4zMjYyMjkxIDc0Ljg3MjgwODQ2IEMxMTcuNTAxMjI5NTYgNzQuNjM3NzAzMjMgMTA2LjY3ODk2MjYzIDc0LjQ4NzczNTYgOTUuODUxNDU3MyA3NC40Mzk0OTI3NiBDOTAuMTIxMTI1NDQgNzQuNDExMTM1NzcgODQuMzk4MjY4MTkgNzQuMzQxNTAwNTcgNzguNjcwMjc4NTUgNzQuMTcwMjAwMzUgQzQ5LjY4NjM2MDY0IDcxLjY5OTYxMDMzIDQ5LjY4NjM2MDY0IDcxLjY5OTYxMDMzIDI5LjIzNTg5NzA2IDg4LjQxNzQ4NjE5IFogIiBmaWxsPSIjOUQ4QkY1IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNDkuMTE0OTMzMDEzOTE2MDIsMC4yNjE3MTMwMjc5NTQxMDE1NikiLz4KPHBhdGggZD0iTTAgMCBDMS41NzQ0Njg3OSAwLjAzNTM4NjUzIDMuMTQ4OTE2MjIgMC4wNzE3MzQ1NiA0LjcyMzM0MjkgMC4xMDg5NDc3NSBDNi4zODkyMjk2MyAwLjExMTc2OTk0IDguMDU1MTI4NzkgMC4xMTAxODIzMiA5LjcyMTAwODMgMC4xMDQ1MjI3MSBDMTQuMjM2MDY1MjggMC4xMDE2NTU4MyAxOC43NDg0NjAyNSAwLjE2MDM5ODE5IDIzLjI2Mjg5ODkyIDAuMjMwMjYyMjggQzI3Ljk4MzMwOTk4IDAuMjkyODIwOCAzMi43MDM3ODM2NiAwLjI5ODY1Mjk0IDM3LjQyNDU0NTI5IDAuMzEwNTE2MzYgQzQ2LjM2MDM4MjA3IDAuMzQxNTg1MTUgNTUuMjk0OTkzODkgMC40MjM2MjcxNSA2NC4yMzAyOTE0OSAwLjUyNDAxMTI1IEM3NC40MDQxODY5OCAwLjYzNTgyNjYzIDg0LjU3ODE0MTMxIDAuNjkwNzc3NjYgOTQuNzUyNDk4MzkgMC43NDA5NjU2IEMxMTUuNjc4NTIxOTMgMC44NDU0NjI2NCAxMzYuNjAzNDQzMTEgMS4wMjEzMjgxNSAxNTcuNTI4NTE4NjggMS4yNDQyMDE2NiBDMTU3Ljk1OTcxNTc1IDEuOTkxNjgzNTYgMTU4LjM5MDkxMjgyIDIuNzM5MTY1NDYgMTU4LjgzNTE3NjQ3IDMuNTA5Mjk4MzIgQzE2MC40NTQ3MTkwNiA2LjMxNjc0Njk5IDE2Mi4wNzQyOTAyOCA5LjEyNDE3OTE0IDE2My42OTM4ODAwOCAxMS45MzE2MDA1NyBDMTY0LjM5MTE0OTMyIDEzLjE0MDI3MDc0IDE2NS4wODg0MDc1NyAxNC4zNDg5NDcyNSAxNjUuNzg1NjU0MDcgMTUuNTU3NjMwNTQgQzE2OS41MDczODE2NCAyMi4wMDkyNjI5MyAxNzMuMjI5NzEyOTcgMjguNDYwNTM4NiAxNzYuOTU4MjA2MTggMzQuOTA4MjY0MTYgQzE4MC40ODk1MDkxNSA0MS4wMTU3MjU1OCAxODQuMDEyMzc2MiA0Ny4xMjc5OTk4IDE4Ny41Mjg1MTg2OCA1My4yNDQyMDE2NiBDMTg4LjAzMjcwMzI1IDU0LjEyMDQ0MTg5IDE4OC41MzY4ODc4MiA1NC45OTY2ODIxMyAxODkuMDU2MzUwNzEgNTUuODk5NDc1MSBDMTkwLjM2NDcyMDkgNTguMTc4MTYzMzYgMTkxLjY2Njg4MDIyIDYwLjQ2MDI0MDk5IDE5Mi45NjYwMTg2OCA2Mi43NDQyMDE2NiBDMTkzLjMzNzc1MjA4IDYzLjM5MDgyNzY0IDE5My43MDk0ODU0NyA2NC4wMzc0NTM2MSAxOTQuMDkyNDgzNTIgNjQuNzAzNjc0MzIgQzE5Ni41Mjg1MTg2OCA2OS4wMTI0Nzg3NyAxOTYuNTI4NTE4NjggNjkuMDEyNDc4NzcgMTk2LjUyODUxODY4IDcxLjI0NDIwMTY2IEMxNDAuMDk4NTE4NjggNzEuNTc0MjAxNjYgODMuNjY4NTE4NjggNzEuOTA0MjAxNjYgMjUuNTI4NTE4NjggNzIuMjQ0MjAxNjYgQzIxLjIzODUxODY4IDc5LjgzNDIwMTY2IDE2Ljk0ODUxODY4IDg3LjQyNDIwMTY2IDEyLjUyODUxODY4IDk1LjI0NDIwMTY2IEMxMS44Njg1MTg2OCA5Ni4yMzQyMDE2NiAxMS4yMDg1MTg2OCA5Ny4yMjQyMDE2NiAxMC41Mjg1MTg2OCA5OC4yNDQyMDE2NiBDMTEuNTY5MTk1NTggOTguMjQxMDU5MjYgMTIuNjA5ODcyNDcgOTguMjM3OTE2ODUgMTMuNjgyMDg1MDQgOTguMjM0Njc5MjIgQzM4Ljk5NTI3MTg5IDk4LjE2MDMwMTE4IDY0LjMwODEwMjk5IDk4LjEzNzU1MDY0IDg5LjYyMTM4NTU3IDk4LjE2OTA0MzU0IEMxMDEuODYyNzI4MTMgOTguMTgzMDc2MDUgMTE0LjEwMzYzNjY4IDk4LjE4MDI4NjgyIDEyNi4zNDQ5MjQ5MyA5OC4xMzgwMDA0OSBDMTM3LjAxMzU1MTU0IDk4LjEwMTE4OTMzIDE0Ny42ODE2NDg5MiA5OC4wOTU4MzQ0NyAxNTguMzUwMjk3ODEgOTguMTI4MzcyMjUgQzE2NC4wMDAzNDQ2MyA5OC4xNDQ1MDIzMiAxNjkuNjQ5Mzk4NjQgOTguMTQ0Nzk5NjEgMTc1LjI5OTM2NiA5OC4xMDc0MzUyMyBDMTgwLjYxNjk2MDY2IDk4LjA3Mjc2NTY4IDE4NS45MzI4MzU5NiA5OC4wODAxNDAyMyAxOTEuMjUwMzc5NTYgOTguMTE5ODMxMDkgQzE5My4yMDIyODQ3MiA5OC4xMjY5NzczMyAxOTUuMTU0MzE1OTQgOTguMTE4NzMyMDYgMTk3LjEwNjA3NzE5IDk4LjA5Mzk3Njk3IEMyMTEuODc3NjkwMTEgOTcuOTE5MzY4MDkgMjExLjg3NzY5MDExIDk3LjkxOTM2ODA5IDIxNS45NzY2MTIwOSAxMDEuMjA4ODYxMzUgQzIxNy41NDk5OTcyNyAxMDMuNTIyOTA2MTcgMjE4LjU2Mjc2MDcgMTA1LjYyODM1NTY1IDIxOS41Mjg1MTg2OCAxMDguMjQ0MjAxNjYgQzIyMC41MTc1NTE4OCAxMDkuODM4ODEyMjYgMjIwLjUxNzU1MTg4IDEwOS44Mzg4MTIyNiAyMjEuNTI2NTY1NTUgMTExLjQ2NTYzNzIxIEMyMjMuMzgxOTAzNjcgMTE0LjYwOTAyNDM0IDIyNS4yMDk1MTMwNyAxMTcuNzY3MTU1ODkgMjI3LjAyODUxODY4IDEyMC45MzE3MDE2NiBDMjI3LjY4NTk0MDU1IDEyMi4wMzMyMDU1NyAyMjguMzQzMzYyNDMgMTIzLjEzNDcwOTQ3IDIyOS4wMjA3MDYxOCAxMjQuMjY5NTkyMjkgQzIyOS45MzcyMjk2MSAxMjUuODcxNTc0NzEgMjI5LjkzNzIyOTYxIDEyNS44NzE1NzQ3MSAyMzAuODcyMjY4NjggMTI3LjUwNTkyMDQxIEMyMzEuNDMxMDc3MjcgMTI4LjQ2NDU4MDA4IDIzMS45ODk4ODU4NiAxMjkuNDIzMjM5NzUgMjMyLjU2NTYyODA1IDEzMC40MTA5NDk3MSBDMjMzLjgzOTE5MTI2IDEzNC4xNTgzMzg0IDIzMy4xNTA1MTE1NyAxMzUuNjgwNjQ5NjEgMjMxLjUyODUxODY4IDEzOS4yNDQyMDE2NiBDMjMwLjQ1NTQ5MzMyIDE0MS4zMTU1MTkzMiAyMjkuMzI3OTEzMzkgMTQzLjM1OTE2OTUyIDIyOC4xNTc0MjQ5MyAxNDUuMzc3MDE0MTYgQzIyNy41MDA2NDc1OCAxNDYuNTEyNjc4MjIgMjI2Ljg0Mzg3MDI0IDE0Ny42NDgzNDIyOSAyMjYuMTY3MTkwNTUgMTQ4LjgxODQyMDQxIEMyMjUuODI2MTUyOTUgMTQ5LjQwMTU2MDA2IDIyNS40ODUxMTUzNiAxNDkuOTg0Njk5NzEgMjI1LjEzMzc0MzI5IDE1MC41ODU1MTAyNSBDMjI0LjA5MTc2Mzc4IDE1Mi4zNjc5MjcwOSAyMjMuMDU4NTM2NTUgMTU0LjE1NTE5Mzk4IDIyMi4wMjY1NjU1NSAxNTUuOTQzNDIwNDEgQzIxOC4zMTAwOTQ0NCAxNjIuMzQyNTkzOTggMjE4LjMxMDA5NDQ0IDE2Mi4zNDI1OTM5OCAyMTYuNTI4NTE4NjggMTY1LjI0NDIwMTY2IEMyMTYuMTY1MTM5OTUgMTY1Ljk1MDEyNTc3IDIxNS44MDE3NjEyMyAxNjYuNjU2MDQ5ODggMjE1LjQyNzM3MTAzIDE2Ny4zODMzNjU2MyBDMjEyLjUwODY1Mjc1IDE3MC4yNDM2NDkxNyAyMDkuMzI3NDgyMDMgMTY5LjgwMTU5NTk1IDIwNS40NjEwOTAwOSAxNjkuNzYzMTgzNTkgQzIwNC42Mjk1NjU2OCAxNjkuNzcwNjg0ODUgMjAzLjc5ODA0MTI4IDE2OS43NzgxODYxIDIwMi45NDEzMTkxNyAxNjkuNzg1OTE0NjYgQzIwMC4xNDUwMjA5NyAxNjkuODA2MjcyNTQgMTk3LjM0OTUyNzM3IDE2OS43OTgwNzM0NCAxOTQuNTUzMTc2ODggMTY5Ljc5MDEwMDEgQzE5Mi41NTI3NTE2IDE2OS43OTg4MzA3MiAxOTAuNTUyMzMzMzIgMTY5LjgwOTMxNDcgMTg4LjU1MTkyNTY2IDE2OS44MjE0MjYzOSBDMTgzLjExMjEzODk2IDE2OS44NDkzNjk1OSAxNzcuNjcyNTc5MTcgMTY5Ljg1MjY4OTI0IDE3Mi4yMzI3MzExIDE2OS44NTE3MDY1IEMxNjYuNTUxMTc5MzkgMTY5Ljg1NDgyODQ3IDE2MC44Njk3MzA5NyAxNjkuODgwNDMxNjggMTU1LjE4ODIzMjQyIDE2OS45MDM2ODY1MiBDMTQ0LjQyNTQyMTI3IDE2OS45NDQzMDUwOCAxMzMuNjYyNjcwNzggMTY5Ljk2NDYwMDk5IDEyMi44OTk3OTQ3NiAxNjkuOTc3NjYwNDIgQzExMC42NDgzOTIyMiAxNjkuOTkzNTEwNjUgOTguMzk3MDkzMjMgMTcwLjAzMTkxNzkxIDg2LjE0NTc1MDY0IDE3MC4wNzIyNTM3IEM2MC45NDAwNDEzNyAxNzAuMTU0NzMyNzggMzUuNzM0MzM0ODcgMTcwLjIwODc3NDgzIDEwLjUyODUxODY4IDE3MC4yNDQyMDE2NiBDMTAuOTQ3MzgzNDIgMTcwLjk2MDc1OTI4IDExLjM2NjI0ODE3IDE3MS42NzczMTY4OSAxMS43OTc4MDU3OSAxNzIuNDE1NTg4MzggQzEzLjY4Nzg1NTU4IDE3NS42NDk3NDk0MSAxNS41NzY5NDg5NSAxNzguODg0NDY4MDggMTcuNDY2MDE4NjggMTgyLjExOTIwMTY2IEMxOC4xMjUzNzQxNSAxODMuMjQ3MTMxMzUgMTguNzg0NzI5NjEgMTg0LjM3NTA2MTA0IDE5LjQ2NDA2NTU1IDE4NS41MzcxNzA0MSBDMjAuMDkyNDgzNTIgMTg2LjYxMzUzNzYgMjAuNzIwOTAxNDkgMTg3LjY4OTkwNDc5IDIxLjM2ODM2MjQzIDE4OC43OTg4ODkxNiBDMjEuOTQ5NjQ5MDUgMTg5Ljc5Mzg4NDI4IDIyLjUzMDkzNTY3IDE5MC43ODg4NzkzOSAyMy4xMjk4MzcwNCAxOTEuODE0MDI1ODggQzIzLjk2NzUxMzM3IDE5My4yNjk0Njg0IDI0Ljc3NzUxNzQgMTk0Ljc0MjE5OTExIDI1LjUyODUxODY4IDE5Ni4yNDQyMDE2NiBDMTEwLjE3MzUxODY4IDE5Ni43MzkyMDE2NiAxMTAuMTczNTE4NjggMTk2LjczOTIwMTY2IDE5Ni41Mjg1MTg2OCAxOTcuMjQ0MjAxNjYgQzE5NS4wNjA0NzYzOSAyMDEuNjQ4MzI4NTMgMTkzLjg1MTM1OTg1IDIwNC43MjMwMzE0NCAxOTEuNTc5Mjk5OTMgMjA4LjYwMzU3NjY2IEMxOTAuOTg1Njg2NjUgMjA5LjYyNDM1MzAzIDE5MC4zOTIwNzMzNiAyMTAuNjQ1MTI5MzkgMTg5Ljc4MDQ3MTggMjExLjY5NjgzODM4IEMxODguODIwNDQyNSAyMTMuMzI5MDMzMiAxODguODIwNDQyNSAyMTMuMzI5MDMzMiAxODcuODQxMDE4NjggMjE0Ljk5NDIwMTY2IEMxODYuODI5ODM1MDkgMjE2LjcyOTMxMTk2IDE4NS44MTg2NjA0OCAyMTguNDY0NDI3NTggMTg0LjgwODAyOTE3IDIyMC4xOTk4NTk2MiBDMTgzLjc1NjM0NzQ0IDIyMi4wMDQzMjM0MiAxODIuNzAyMzUyMzEgMjIzLjgwNzQyMTg1IDE4MS42NDgxNDc1OCAyMjUuNjEwNDEyNiBDMTc4LjI0ODMxMTM4IDIzMS40MzEyODgxMSAxNzQuODkxNTY1NTMgMjM3LjI3NzAyMTE4IDE3MS41Mjg1MTg2OCAyNDMuMTE5MjAxNjYgQzE2OC4wMTQ5Njc2NSAyNDkuMjE3MTIzNjMgMTY4LjAxNDk2NzY1IDI0OS4yMTcxMjM2MyAxNjYuMzA3MTU4NDcgMjUyLjA2OTg4OTA3IEMxNjQuNDgzMjAwNjkgMjU1LjE3ODY0NjE1IDE2NC40ODMyMDA2OSAyNTUuMTc4NjQ2MTUgMTYzLjIyNzEwNTE0IDI1OC4zODg1MTU0NyBDMTYxLjY1MTkwOTcxIDI2MS44NzcwMTc3IDE2MC4xNTc1NjE0MiAyNjQuNDQ4MjEwMDUgMTU3LjUyODUxODY4IDI2Ny4yNDQyMDE2NiBDMTUyLjIxNzMxOTQzIDI2OS4xMDI5OTM1NCAxNDYuOTk2MTU3MSAyNjkuMDExNTY2MDIgMTQxLjQ0MjMzNzA0IDI2OC45ODczNjU3MiBDMTM5Ljc5ODkwNTA1IDI2OS4wMjMzMDUyMyAxMzguMTU1NTc0MDYgMjY5LjA2NDE0NTI2IDEzNi41MTIzNzQ4OCAyNjkuMTA5NDk3MDcgQzEzMi4wNTg5NjgyNCAyNjkuMjE1Mjg2NzEgMTI3LjYwODMyODA4IDI2OS4yNDM2MTk3NSAxMjMuMTUzNzg2NDIgMjY5LjI1MTI4NjUxIEMxMjAuMzY1ODIwMDkgMjY5LjI1OTgzNDQ1IDExNy41Nzg1NTA4MyAyNjkuMjg1NDg0NzQgMTE0Ljc5MDc1ODEzIDI2OS4zMTcyNTMxMSBDMTA1LjA0ODM1MjIyIDI2OS40MjgyMjI2MiA5NS4zMDc5MTI1MyAyNjkuNDc3Mjg1MzYgODUuNTY0ODk1NjMgMjY5LjQ2NzgzNDQ3IEM3Ni41MDg2MjU3NSAyNjkuNDYwNjM1MDEgNjcuNDYwOTU4MzMgMjY5LjU4NzAwMDQ1IDU4LjQwNjg2NTA2IDI2OS43NzY3NTg0MyBDNTAuNjEzMzgyNDggMjY5LjkzNDIyMTI2IDQyLjgyMjY5MzcyIDI2OS45OTgwMTk2NiAzNS4wMjc2MzQ2OCAyNjkuOTkwMzY5NTYgQzMwLjM3OTY0MzE1IDI2OS45ODczMjI0IDI1LjczOTI4Nzc2IDI3MC4wMjA2ODE4MyAyMS4wOTI4OTM2IDI3MC4xNDg1MDYxNiBDLTcuMDMzNzc1NTggMjcwLjg2OTgwNjI1IC03LjAzMzc3NTU4IDI3MC44Njk4MDYyNSAtMTQuMzc3Mjg2OTEgMjY0Ljg3MDE1OTE1IEMtMTkuMTAxNjE2NTcgMjU5LjE4MjAxNjMgLTIxLjk2OTc0ODc5IDI1Mi45NDk5NzM4NyAtMjQuNDM5MjI0MjQgMjQ2LjAyNTU2MjI5IEMtMjUuNzc5NTI3NDUgMjQyLjQxNDE4ODEyIC0yNy41NTI4ODc2MSAyMzkuMzg2NzYwNjkgLTI5LjU5MjU3NTA3IDIzNi4xMjcwMTQxNiBDLTMwLjY5ODY1NDQgMjM0LjIwODA5NTE0IC0zMS44MDQxMzg2IDIzMi4yODg4MzI5NCAtMzIuOTA4OTgxMzIgMjMwLjM2OTIwMTY2IEMtMzQuMTY4MDc5MzQgMjI4LjE4NDI5NjI4IC0zNS40MjcxOTQ0MyAyMjUuOTk5NDAwNzQgLTM2LjY4NjMyNTA3IDIyMy44MTQ1MTQxNiBDLTM3LjMxMTM1OTI1IDIyMi43Mjk0NDU4IC0zNy45MzYzOTM0MyAyMjEuNjQ0Mzc3NDQgLTM4LjU4MDM2ODA0IDIyMC41MjY0MjgyMiBDLTQxLjcwODI4MjgxIDIxNS4wOTc2MDIyNCAtNDQuODQwMDY1OCAyMDkuNjcxMDA4ODUgLTQ3Ljk3MTQ4MTMyIDIwNC4yNDQyMDE2NiBDLTQ5LjIyMTUwMDExIDIwMi4wNzc1NDU4MyAtNTAuNDcxNTAwMTEgMTk5LjkxMDg3OTE2IC01MS43MjE0ODEzMiAxOTcuNzQ0MjAxNjYgQy01Mi4zNDAyMzEzMiAxOTYuNjcxNzAxNjYgLTUyLjk1ODk4MTMyIDE5NS41OTkyMDE2NiAtNTMuNTk2NDgxMzIgMTk0LjQ5NDIwMTY2IEMtNTkuMjIxNDgxMzIgMTg0Ljc0NDIwMTY2IC01OS4yMjE0ODEzMiAxODQuNzQ0MjAxNjYgLTYxLjA5OTY1NTE1IDE4MS40ODg1ODY0MyBDLTYyLjMzODk0Mzk5IDE3OS4zNDA1NjEyIC02My41NzgzNjI3MyAxNzcuMTkyNjEwOTEgLTY0LjgxNzkxNjg3IDE3NS4wNDQ3Mzg3NyBDLTY3Ljc1MzUwNyAxNjkuOTU3NjQ2MTcgLTcwLjY4NzczODA0IDE2NC44Njk3ODMxOSAtNzMuNjE3Mzg1ODYgMTU5Ljc3OTI2NjM2IEMtNzUuMDA0NzYyMjcgMTU3LjM2ODc2NDE4IC03Ni4zOTI4Nzc1NiAxNTQuOTU4Njg3OSAtNzcuNzgxMDUxNjQgMTUyLjU0ODY0NTAyIEMtNzguNzYzMjE5NDcgMTUwLjg0Mjc2MTk4IC03OS43NDQzMTUxNyAxNDkuMTM2MjYxOCAtODAuNzI1Mzg3NTcgMTQ3LjQyOTc0ODU0IEMtODEuMzE4MzU2MzIgMTQ2LjQwMDQzMjEzIC04MS45MTEzMjUwNyAxNDUuMzcxMTE1NzIgLTgyLjUyMjI2MjU3IDE0NC4zMTA2MDc5MSBDLTgzLjA0NDczNTcyIDE0My40MDI1NDM5NSAtODMuNTY3MjA4ODYgMTQyLjQ5NDQ3OTk4IC04NC4xMDU1MTQ1MyAxNDEuNTU4ODk4OTMgQy04NS4xNzEyNjA5OCAxMzkuNzUyOTM5NjYgLTg2LjMwODI4ODg1IDEzNy45ODg5OTAzNyAtODcuNDcxNDgxMzIgMTM2LjI0NDIwMTY2IEMtODcuMjIyOTU3ODEgMTMxLjQxOTQxNzU5IC04NC42Mjg0NzI1IDEyNy41MjYwMjM3OSAtODIuMjgzOTgxMzIgMTIzLjQzMTcwMTY2IEMtODEuODQ0MDA4MTggMTIyLjY1MTgxODg1IC04MS40MDQwMzUwMyAxMjEuODcxOTM2MDQgLTgwLjk1MDcyOTM3IDEyMS4wNjg0MjA0MSBDLTc2LjEwODgyOTcyIDExMi41MjQzODI0MiAtNzEuMTM3NzUzNjIgMTA0LjA1NDA4MTEzIC02Ni4xNzQ2MDYzMiA5NS41ODAxMzkxNiBDLTYyLjQzNTEzNTQzIDg5LjE5MTM4MTc0IC01OC43MzAyMzA5OCA4Mi43ODMwNDA5IC01NS4wMzM5ODEzMiA3Ni4zNjkyMDE2NiBDLTU0LjQxMTc2Njk3IDc1LjI4OTYxMTgyIC01My43ODk1NTI2MSA3NC4yMTAwMjE5NyAtNTMuMTQ4NDgzMjggNzMuMDk3NzE3MjkgQy01MS44ODYzNjYxNiA3MC45MDczNzY0NiAtNTAuNjI0NDAzNDcgNjguNzE2OTQ2NjQgLTQ5LjM2MjU5NDYgNjYuNTI2NDI4MjIgQy00NS42MTcwOTY5NyA2MC4wMjU3MjIwMyAtNDEuODY2NTA4NjcgNTMuNTI3OTUxMzQgLTM4LjExNjUwMDg1IDQ3LjAyOTg0NjE5IEMtMzUuMjE4NTMyNDMgNDIuMDA3NjY0NjQgLTMyLjMyMTUzODQ1IDM2Ljk4NDkzMSAtMjkuNDI4NzI2MiAzMS45NTk3Nzc4MyBDLTI4LjQxMjAwOTM0IDMwLjE5Mzc0NjQ0IC0yNy4zOTQ5MjQ3NCAyOC40Mjc5MjczNSAtMjYuMzc3NzMxMzIgMjYuNjYyMTcwNDEgQy0yNS4xMDc0NzI1OSAyNC40NTY4NjAxMSAtMjMuODM3ODkxMTQgMjIuMjUxMTU5NSAtMjIuNTY5MTM3NTcgMjAuMDQ0OTgyOTEgQy0yMS45ODkwNTk0NSAxOS4wMzgyMjUxIC0yMS40MDg5ODEzMiAxOC4wMzE0NjcyOSAtMjAuODExMzI1MDcgMTYuOTk0MjAxNjYgQy0yMC4wNTkwMzYyNSAxNS42ODcwOTIyOSAtMjAuMDU5MDM2MjUgMTUuNjg3MDkyMjkgLTE5LjI5MTU0OTY4IDE0LjM1MzU3NjY2IEMtMTguNjkwOTI3MTIgMTMuMzI3NDgyOTEgLTE4LjA5MDMwNDU3IDEyLjMwMTM4OTE2IC0xNy40NzE0ODEzMiAxMS4yNDQyMDE2NiBDLTE3LjE2NzU4NzA0IDEwLjQzNTI5MjkxIC0xNi44NjM2OTI3NiA5LjYyNjM4NDE2IC0xNi41NTA1ODk1NiA4Ljc5Mjk2MzAzIEMtMTIuOTU1Mjg4NjcgMC42NTYwMzEyIC04LjM4OTk3ODIzIC0wLjAxNjA2MjcgMCAwIFogIiBmaWxsPSIjMUI2M0YyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyMTkuNDcxNDgxMzIzMjQyMiwxMjAuNzU1Nzk4MzM5ODQzNzUpIi8+Cjwvc3ZnPgo=',
            loginData: {},
            ETHERMAIL_API_DOMAIN: getEtherMailAPIDomainByEnvironment(parameters.environment ?? 'production'),
            ETHERMAIL_DOMAIN: getEtherMailDomainByEnvironment(parameters.environment ?? 'production'),
            async connect() {
                const chainId = await this.getChainId();
                const accounts = await this.getAccounts();

                return { accounts, chainId }
            },
            async disconnect() {
                isConnected = false;
                provider = null;
                ethermailProvider = null;

                removeEthermailLoginElement();
                removeEthermailSDKScript();
            },
            async getAccounts() {
                if (!provider) throw new Error('Not connected');
                const signer = await provider.getSigner();

                return [signer.address as `0x${string}`];
            },
            async getChainId() {
                if (!provider) await this.getProvider();

                const network = await provider?.getNetwork();
                if (!network) throw new Error('No network found');

                const chainId = network.chainId.toString();
                return +chainId;
            },
            async getProvider() {
                if (!ethermailProvider) {
                    createEthermailLoginElement(
                        parameters.widget_id ?? '',
                        parameters.loginType ?? 'wallet',
                        parameters.permissions ?? 'write',
                        parameters.connectButtonLabel ?? 'Connect Wallet'
                    );

                    await runEthermailSDKScript(
                        parameters.environment ?? 'production',
                        parameters.afid,
                        parameters.community_name,
                    );

                    await new Promise((resolve) => {
                        const check = () => {
                            if (customElements.get('ethermail-login')) resolve(true);
                            else setTimeout(check, 50);
                        };
                        check();
                    });

                    const ethermailLogin = document.querySelector('ethermail-login');
                    if (!ethermailLogin) {
                        throw new Error('Ethermail login element not found');
                    }

                    const shadowRoot = ethermailLogin.shadowRoot;
                    if (!shadowRoot) {
                        throw new Error('Shadow root not found');
                    }

                    const loginButton = shadowRoot.querySelector('.ethermail-login-button');
                    if (!loginButton) {
                        throw new Error('Ethermail login button not found');
                    }
                    (loginButton as HTMLElement).click();

                    addEthermailLoginErrorListener();

                    return await new Promise<EtherMailProvider>((resolve, reject) => {
                        let timeoutId = setTimeout(() => {
                            reject(new Error('Ethermail login timed out after 60 seconds'));
                        }, 60000); // 60-second timeout

                        const handleSignInSuccess = async (event: Event) => {
                            const successEvent = event as EtherMailSignInOnSuccessEvent;

                            const sessionToken = successEvent.detail.token;
                            this.loginData = jwtDecode(sessionToken);

                            ethermailProvider = new EtherMailProvider({
                                websocketServer: `wss://${this.ETHERMAIL_API_DOMAIN}/events`,
                                appUrl: `https://${this.ETHERMAIL_DOMAIN}`,
                            });

                            provider = new BrowserProvider(ethermailProvider);
                            isConnected = true;
                            clearTimeout(timeoutId);

                            resolve(ethermailProvider);
                        };

                        window.addEventListener('EtherMailSignInOnSuccess', handleSignInSuccess, { once: true });
                    });
                }

                return ethermailProvider;
            },
            async switchChain({ addEthereumChainParameter, chainId }) {
                if (!provider) await this.getProvider()
                if (!ethermailProvider) throw new Error('Connect wallet before');

                const chain = config.chains.find((x: Chain) => x.id === chainId)
                await ethermailProvider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainId }],
                });

                provider = getBrowserProvider(ethermailProvider);

                config.emitter.emit('change', { chainId })

                return chain;
            },
            async isAuthorized() {
                return isConnected;
            },
            onAccountsChanged(accounts: `0x${string}`[]) {},
            onChainChanged(chainId: string) {},
            onDisconnect() {},
        };
    });
}

const getEtherMailAPIDomainByEnvironment = (environment: EnvironmentType) => {
    const baseEthermailAPIDomain = 'api.ethermail.io';

    return getDomainByEnvironment(baseEthermailAPIDomain, environment);
}

const getEtherMailDomainByEnvironment = (environment: EnvironmentType) => {
    const baseEthermailDomain = 'ethermail.io';

    return getDomainByEnvironment(baseEthermailDomain, environment, '.');
}

const getDomainByEnvironment = (baseDomain: string, environment: EnvironmentType, separation = '-') => {
    if (environment !== 'production') {

        return `${environment.toLowerCase()}${separation}${baseDomain}`;
    }

    return baseDomain;
}

const getEtherMailSDKScriptUrl = (environment: EnvironmentType) => {
    const baseScriptUrl = 'https://cdn-email.ethermail.io/sdk/v2/ethermail.js';

    if (environment !== 'production') {
        const urlParts = baseScriptUrl.split('ethermail.js');
        return `${urlParts[0]}${environment}-ethermail.js`;
    }

    return baseScriptUrl;
}

const getBrowserProvider = (ethermailProvider: EtherMailProvider) => {
    return new BrowserProvider(ethermailProvider);
}

const createEthermailLoginElement = (widgetId: string, loginType: string, ssoPermission: string, label: string) => {
    if (!document.getElementById('ethermail-login')) {
        const ethermailLogin = document.createElement('ethermail-login');

        // Set attributes (widget, type, permissions, label)
        ethermailLogin.setAttribute('widget', widgetId);
        ethermailLogin.setAttribute('type', loginType);
        ethermailLogin.setAttribute('permissions', ssoPermission);
        ethermailLogin.setAttribute('label', label);

        ethermailLogin.style.position = 'absolute'; // Option 2: Move off-screen
        ethermailLogin.style.left = '-9999px';

        // Append to the document body
        document.body.appendChild(ethermailLogin);
    }
}

const runEthermailSDKScript = async (environment: EnvironmentType, afid: string, communityAlias: string,) => {
    const scriptUrl = getEtherMailSDKScriptUrl(environment);

    (function({ ...args }) {
        if (!document.getElementById('ethermail-sdk-script')) {
            var p = document.createElement('script');
            p.id = 'ethermail-sdk-script';
            p.src = scriptUrl ?? 'https://cdn-email.ethermail.io/sdk/v2/ethermail.js';
            document.body.appendChild(p);
            p.setAttribute('a', args.afid);
            p.setAttribute('b', args.communityAlias);
            // @ts-ignore
            p.setAttribute('c', args.features);
        }
    })({
        afid,
        communityAlias,
        features: ['login'],
    });
}

const removeEthermailLoginElement = () => {
    const ethermailLogin = document.querySelector('ethermail-login');
    if (ethermailLogin) {
        ethermailLogin.remove();
    }
};

const removeEthermailSDKScript = () => {
    const sdkScript = document.getElementById('ethermail-sdk-script');
    if (sdkScript) {
        sdkScript.remove();
    }
};

const addEthermailLoginErrorListener = () => {
    window.addEventListener('EtherMailTokenError', (event: Event) => {
        console.log(event);
        const errorEvent = event as EtherMailTokenErrorEvent;
        if (errorEvent.detail.type === 'expired') {
            console.error('Expired Session!')
        } else if (errorEvent.detail.type === 'permissions') {
            console.error('Permissions Error!');
        }
    });
}

function validateParameters(parameters: EthermailConnectorParameters) {
    // Check if parameters is an object and not null/undefined
    if (!parameters || typeof parameters !== 'object' || Array.isArray(parameters)) {
        throw new Error('Parameters must be a valid object');
    }

    // 1. Validate widget_id (Mongo ID: 24 characters, exists, is string)
    if (!parameters.widget_id || typeof parameters.widget_id !== 'string' || parameters.widget_id.length !== 24) {
        throw new Error('widget_id must be a 24-character string');
    }

    // 2. Validate afid (Mongo ID: 24 characters, exists, is string)
    if (!parameters.afid || typeof parameters.afid !== 'string' || parameters.afid.length !== 24) {
        throw new Error('afid must be a 24-character string');
    }

    // 3. Validate community_name (exists and not empty)
    if (!parameters.community_name || parameters.community_name === '') {
        throw new Error('community_name must be a non-empty string');
    }

    // 4. Validate permissions (must be "read" or "write")
    if (!parameters.permissions || (parameters.permissions !== 'read' && parameters.permissions !== 'write')) {
        throw new Error('permissions must be either "read" or "write"');
    }

    // 5. Validate loginType (must be "wallet")
    if (!parameters.loginType || parameters.loginType !== 'wallet') {
        throw new Error('loginType must be "wallet"');
    }

    // 6. Validate environment (must be "dev", "staging", or "production")
    if (!parameters.environment || !['dev', 'staging', 'production'].includes(parameters.environment)) {
        throw new Error('environment must be "dev", "staging", or "production"');
    }
}